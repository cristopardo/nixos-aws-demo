AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Demo mínima: instancia EC2 con IP pública, SG administrado por CloudFormation
  y URL de acceso HTTP.

Parameters:
  InstanceAmiId:
    Type: AWS::EC2::Image::Id
    Description: ID de la AMI (usa una Amazon Linux / Ubuntu / NixOS válida).
    # NixOS 23.05 en us-east-1, x86_64 hvm-ebs
    Default: ami-07df5833f04703a2a

  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.nano
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
    Description: Tipo de instancia EC2.

  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Nombre de un KeyPair existente para conectarnos por SSH.
    Default: nixos-demo-keypair

  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Subred (idealmente pública) donde se creará la instancia.
    Default: subnet-08d0e1d36a28f6d2a

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC donde se creará el Security Group de la instancia.
    Default: vpc-0a7195ef0f9bf6908

Resources:
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group para demo NixOS EC2
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        # SSH desde Internet (para demo)
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        # HTTP desde Internet
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-sg"

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId:      !Ref InstanceAmiId
      InstanceType: !Ref InstanceType
      KeyName:      !Ref KeyName

      SubnetId: !Ref SubnetId
      SecurityGroupIds:
        - !Ref InstanceSecurityGroup

      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-demo-ec2"

Outputs:
  InstanceId:
    Description: ID de la instancia EC2 creada
    Value: !Ref EC2Instance

  InstancePublicIp:
    Description: IP pública de la instancia
    Value: !GetAtt EC2Instance.PublicIp

  InstancePublicDns:
    Description: DNS público de la instancia
    Value: !GetAtt EC2Instance.PublicDnsName

  InstanceHttpUrl:
    Description: URL HTTP usando el DNS público (ideal para backend/frontend)
    Value: !Sub "http://${EC2Instance.PublicDnsName}"
